{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/victo/OneDrive/Escritorio/TFG/TFG-C\\xF3digo/Frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { HttpHeaders } from '@angular/common/http';\nimport { of } from 'rxjs';\nimport { catchError, map, tap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class AuthService {\n  constructor(http) {\n    this.http = http;\n    this.baseUrl = environment.baseUrl;\n  }\n\n  get auth() {\n    return { ...this._auth\n    };\n  }\n\n  get usuario() {\n    return { ...this._usuario\n    };\n  }\n\n  subirImagen(imagen) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.readAsArrayBuffer(imagen);\n\n        reader.onloadend = () => {\n          const buffer = reader.result;\n          const imagen_array = Array.from(new Uint8Array(buffer));\n          const imagen_base64 = btoa(String.fromCharCode(...imagen_array));\n          const url = `${_this.baseUrl}/subir-imagen`;\n          const body = {\n            imagen: imagen_base64\n          };\n          const options = {\n            headers: {\n              'Content-Type': 'application/json'\n            }\n          };\n\n          _this.http.post(url, body, options).toPromise().then(response => resolve(response)).catch(error => reject(error));\n        };\n\n        reader.onerror = error => {\n          reject(error);\n        };\n      });\n    })();\n  }\n\n  registraUsuario(datosPersonales, inicioSesion) {\n    // TODO: Definir correctamente los datos a enviar, comprobar modelo Usuario en bd\n    let body = {\n      nombre: datosPersonales.controls['nombre'].value,\n      email: inicioSesion.controls['email'].value,\n      password: inicioSesion.controls['password'].value,\n      listaRestaurantesFavoritos: [],\n      fotografia: datosPersonales.controls['fotografia'].value,\n      listaOpiniones: [],\n      fechaNacimiento: datosPersonales.controls['fechaNacimiento'].value,\n      google: false\n    };\n    this.subirImagen(datosPersonales.controls['fotografia'].value._files[0]); //return this.http.post<Auth>(`${this.baseUrl}/nuevo-usuario`, body);\n  }\n\n  verificaAutenticacion() {\n    if (!localStorage.getItem('token')) {\n      return of(false); // Creamos el observable del false\n    }\n\n    return this.http.get(`${this.baseUrl}/login`).pipe(map(auth => {\n      this._auth = auth;\n      return true;\n    }));\n  }\n\n  login(email, password) {\n    const body = {\n      email,\n      password\n    };\n    return this.http.post(`${this.baseUrl}/login`, body).pipe(tap(resp => {\n      if (resp.ok) {\n        localStorage.setItem('token', resp.token);\n        this._usuario = {\n          nombre: resp.nombre,\n          uid: resp.uid,\n          email: resp.email\n        };\n      }\n    }), map(resp => resp.ok));\n  }\n\n  logOut() {\n    localStorage.removeItem('token');\n    this._auth = undefined;\n  }\n\n  validarToken() {\n    const url = `${this.baseUrl}/auth/renovar`;\n    const headers = new HttpHeaders().set('x-token', localStorage.getItem('token') || '');\n    return this.http.get(url, {\n      headers\n    }).pipe(map(resp => {\n      localStorage.setItem('token', resp.token);\n      this._usuario = {\n        nombre: resp.nombre,\n        uid: resp.uid,\n        email: resp.email\n      };\n      return resp.ok;\n    }), catchError(err => of(false)));\n  }\n\n}\n\nAuthService.ɵfac = function AuthService_Factory(t) {\n  return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient));\n};\n\nAuthService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: AuthService,\n  factory: AuthService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["HttpHeaders","of","catchError","map","tap","environment","AuthService","constructor","http","baseUrl","auth","_auth","usuario","_usuario","subirImagen","imagen","Promise","resolve","reject","reader","FileReader","readAsArrayBuffer","onloadend","buffer","result","imagen_array","Array","from","Uint8Array","imagen_base64","btoa","String","fromCharCode","url","body","options","headers","post","toPromise","then","response","catch","error","onerror","registraUsuario","datosPersonales","inicioSesion","nombre","controls","value","email","password","listaRestaurantesFavoritos","fotografia","listaOpiniones","fechaNacimiento","google","_files","verificaAutenticacion","localStorage","getItem","get","pipe","login","resp","ok","setItem","token","uid","logOut","removeItem","undefined","validarToken","set","err","i0","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\victo\\OneDrive\\Escritorio\\TFG\\TFG-Código\\Frontend\\src\\app\\auth\\services\\auth.service.ts"],"sourcesContent":["import { HttpClient, HttpHeaders } from '@angular/common/http';\nimport { Injectable } from '@angular/core';\nimport { FormGroup } from '@angular/forms';\nimport { Observable, of } from 'rxjs';\nimport { catchError, map, tap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport { Auth, AuthResponse, Usuario } from '../interfaces/auth.interfaces';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class AuthService {\n  private baseUrl: string = environment.baseUrl;\n  private _auth!: Auth | undefined;\n  private _usuario!: Usuario;\n\n  constructor(private http: HttpClient) {}\n\n  get auth(): Auth {\n    return { ...this._auth! };\n  }\n\n  get usuario(): Usuario {\n    return { ...this._usuario };\n  }\n\n  async subirImagen(imagen: File): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.readAsArrayBuffer(imagen);\n      reader.onloadend = () => {\n        const buffer = reader.result as ArrayBuffer;\n        const imagen_array = Array.from(new Uint8Array(buffer));\n        const imagen_base64 = btoa(String.fromCharCode(...imagen_array));\n        const url = `${this.baseUrl}/subir-imagen`;\n        const body = { imagen: imagen_base64 };\n        const options = { headers: { 'Content-Type': 'application/json' } };\n        this.http\n          .post(url, body, options)\n          .toPromise()\n          .then((response) => resolve(response))\n          .catch((error) => reject(error));\n      };\n      reader.onerror = (error) => {\n        reject(error);\n      };\n    });\n  }\n\n  registraUsuario(datosPersonales: FormGroup, inicioSesion: FormGroup) {\n    // TODO: Definir correctamente los datos a enviar, comprobar modelo Usuario en bd\n    let body: any = {\n      nombre: datosPersonales.controls['nombre'].value,\n      email: inicioSesion.controls['email'].value,\n      password: inicioSesion.controls['password'].value,\n      listaRestaurantesFavoritos: [],\n      fotografia: datosPersonales.controls['fotografia'].value,\n      listaOpiniones: [],\n      fechaNacimiento: datosPersonales.controls['fechaNacimiento'].value,\n      google: false,\n    };\n    this.subirImagen(datosPersonales.controls['fotografia'].value._files[0]);\n    //return this.http.post<Auth>(`${this.baseUrl}/nuevo-usuario`, body);\n  }\n\n  verificaAutenticacion(): Observable<boolean> {\n    if (!localStorage.getItem('token')) {\n      return of(false); // Creamos el observable del false\n    }\n    return this.http.get<Auth>(`${this.baseUrl}/login`).pipe(\n      map((auth) => {\n        this._auth = auth;\n        return true;\n      })\n    );\n  }\n\n  login(email: string, password: string) {\n    const body = { email, password };\n    return this.http.post<AuthResponse>(`${this.baseUrl}/login`, body).pipe(\n      tap((resp) => {\n        if (resp.ok) {\n          localStorage.setItem('token', resp.token!);\n          this._usuario = {\n            nombre: resp.nombre!,\n            uid: resp.uid!,\n            email: resp.email!,\n          };\n        }\n      }),\n      map((resp) => resp.ok)\n    );\n  }\n\n  logOut() {\n    localStorage.removeItem('token');\n    this._auth = undefined;\n  }\n\n  validarToken(): Observable<boolean> {\n    const url = `${this.baseUrl}/auth/renovar`;\n    const headers = new HttpHeaders().set(\n      'x-token',\n      localStorage.getItem('token') || ''\n    );\n\n    return this.http.get<AuthResponse>(url, { headers }).pipe(\n      map((resp) => {\n        localStorage.setItem('token', resp.token!);\n        this._usuario = {\n          nombre: resp.nombre!,\n          uid: resp.uid!,\n          email: resp.email!,\n        };\n        return resp.ok;\n      }),\n      catchError((err) => of(false))\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}