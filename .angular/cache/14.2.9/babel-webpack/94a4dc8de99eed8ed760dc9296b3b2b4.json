{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/victo/OneDrive/Escritorio/TFG/TFG-C\\xF3digo/Frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { HttpHeaders } from '@angular/common/http';\nimport { of } from 'rxjs';\nimport { catchError, map, tap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class AuthService {\n  constructor(http) {\n    this.http = http;\n    this.baseUrl = environment.baseUrl;\n  }\n\n  get auth() {\n    return { ...this._auth\n    };\n  }\n\n  get usuario() {\n    return { ...this._usuario\n    };\n  }\n\n  subirImagen(imagen) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.readAsArrayBuffer(imagen);\n\n        reader.onloadend = () => {\n          const buffer = reader.result;\n          const imagen_array = Array.from(new Uint8Array(buffer));\n          const imagen_base64 = btoa(String.fromCharCode(...imagen_array));\n          const url = `${_this.baseUrl}/subir-imagen`;\n          const body = {\n            imagen: imagen_base64\n          };\n\n          _this.http.post(url, body).toPromise().then(response => resolve(response)).catch(error => reject(error));\n        };\n\n        reader.onerror = error => {\n          reject(error);\n        };\n      });\n    })();\n  }\n\n  registraUsuario(datosPersonales, inicioSesion) {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      let idImagen;\n      yield _this2.subirImagen(datosPersonales.controls['fotografia'].value._files[0]).then(resp => idImagen = resp.idImagen);\n      let anio = datosPersonales.controls['fechaNacimiento'].value.getFullYear();\n      let dia = datosPersonales.controls['fechaNacimiento'].value.getDay();\n      let mes = datosPersonales.controls['fechaNacimiento'].value.getMonth();\n      const fechaNacimientoParseada = `${anio}-${mes}-${dia}`;\n      let body = {\n        nombre: datosPersonales.controls['nombre'].value,\n        email: inicioSesion.controls['email'].value,\n        password: inicioSesion.controls['password'].value,\n        listaRestaurantesFavoritos: [],\n        fotografia: idImagen,\n        listaOpiniones: [],\n        fechaNacimiento: fechaNacimientoParseada,\n        google: false\n      };\n      return _this2.http.post(`${_this2.baseUrl}/nuevo-usuario`, body).pipe(map(resp => resp.ok));\n    })();\n  }\n\n  verificaAutenticacion() {\n    if (!localStorage.getItem('token')) {\n      return of(false); // Creamos el observable del false\n    }\n\n    return this.http.get(`${this.baseUrl}/login`).pipe(map(auth => {\n      this._auth = auth;\n      return true;\n    }));\n  }\n\n  login(email, password) {\n    const body = {\n      email,\n      password\n    };\n    return this.http.post(`${this.baseUrl}/login`, body).pipe(tap(resp => {\n      if (resp.ok) {\n        localStorage.setItem('token', resp.token);\n        this._usuario = {\n          nombre: resp.nombre,\n          uid: resp.uid,\n          email: resp.email\n        };\n      }\n    }), map(resp => resp.ok));\n  }\n\n  logOut() {\n    localStorage.removeItem('token');\n    this._auth = undefined;\n  }\n\n  validarToken() {\n    const url = `${this.baseUrl}/auth/renovar`;\n    const headers = new HttpHeaders().set('x-token', localStorage.getItem('token') || '');\n    return this.http.get(url, {\n      headers\n    }).pipe(map(resp => {\n      localStorage.setItem('token', resp.token);\n      this._usuario = {\n        nombre: resp.nombre,\n        uid: resp.uid,\n        email: resp.email\n      };\n      return resp.ok;\n    }), catchError(err => of(false)));\n  }\n\n}\n\nAuthService.ɵfac = function AuthService_Factory(t) {\n  return new (t || AuthService)(i0.ɵɵinject(i1.HttpClient));\n};\n\nAuthService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: AuthService,\n  factory: AuthService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["HttpHeaders","of","catchError","map","tap","environment","AuthService","constructor","http","baseUrl","auth","_auth","usuario","_usuario","subirImagen","imagen","Promise","resolve","reject","reader","FileReader","readAsArrayBuffer","onloadend","buffer","result","imagen_array","Array","from","Uint8Array","imagen_base64","btoa","String","fromCharCode","url","body","post","toPromise","then","response","catch","error","onerror","registraUsuario","datosPersonales","inicioSesion","idImagen","controls","value","_files","resp","anio","getFullYear","dia","getDay","mes","getMonth","fechaNacimientoParseada","nombre","email","password","listaRestaurantesFavoritos","fotografia","listaOpiniones","fechaNacimiento","google","pipe","ok","verificaAutenticacion","localStorage","getItem","get","login","setItem","token","uid","logOut","removeItem","undefined","validarToken","headers","set","err","i0","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\victo\\OneDrive\\Escritorio\\TFG\\TFG-Código\\Frontend\\src\\app\\auth\\services\\auth.service.ts"],"sourcesContent":["import { HttpClient, HttpHeaders } from '@angular/common/http';\nimport { Injectable } from '@angular/core';\nimport { FormGroup } from '@angular/forms';\nimport { Observable, of } from 'rxjs';\nimport { catchError, map, tap } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport { Auth, AuthResponse, Usuario } from '../interfaces/auth.interfaces';\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class AuthService {\n  private baseUrl: string = environment.baseUrl;\n  private _auth!: Auth | undefined;\n  private _usuario!: Usuario;\n\n  constructor(private http: HttpClient) {}\n\n  get auth(): Auth {\n    return { ...this._auth! };\n  }\n\n  get usuario(): Usuario {\n    return { ...this._usuario };\n  }\n\n  async subirImagen(imagen: File): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.readAsArrayBuffer(imagen);\n      reader.onloadend = () => {\n        const buffer = reader.result as ArrayBuffer;\n        const imagen_array = Array.from(new Uint8Array(buffer));\n        const imagen_base64 = btoa(String.fromCharCode(...imagen_array));\n        const url = `${this.baseUrl}/subir-imagen`;\n        const body = { imagen: imagen_base64 };\n        this.http\n          .post(url, body)\n          .toPromise()\n          .then((response) => resolve(response))\n          .catch((error) => reject(error));\n      };\n      reader.onerror = (error) => {\n        reject(error);\n      };\n    });\n  }\n  async registraUsuario(datosPersonales: FormGroup, inicioSesion: FormGroup) {\n    let idImagen;\n    await this.subirImagen(\n      datosPersonales.controls['fotografia'].value._files[0]\n    ).then((resp) => (idImagen = resp.idImagen));\n\n    let anio = datosPersonales.controls['fechaNacimiento'].value.getFullYear();\n    let dia = datosPersonales.controls['fechaNacimiento'].value.getDay();\n    let mes = datosPersonales.controls['fechaNacimiento'].value.getMonth();\n    const fechaNacimientoParseada = `${anio}-${mes}-${dia}`;\n\n    let body: any = {\n      nombre: datosPersonales.controls['nombre'].value,\n      email: inicioSesion.controls['email'].value,\n      password: inicioSesion.controls['password'].value,\n      listaRestaurantesFavoritos: [],\n      fotografia: idImagen,\n      listaOpiniones: [],\n      fechaNacimiento: fechaNacimientoParseada,\n      google: false,\n    };\n\n    return this.http\n      .post<any>(`${this.baseUrl}/nuevo-usuario`, body)\n      .pipe(map((resp) => resp.ok));\n  }\n\n  verificaAutenticacion(): Observable<boolean> {\n    if (!localStorage.getItem('token')) {\n      return of(false); // Creamos el observable del false\n    }\n    return this.http.get<Auth>(`${this.baseUrl}/login`).pipe(\n      map((auth) => {\n        this._auth = auth;\n        return true;\n      })\n    );\n  }\n\n  login(email: string, password: string) {\n    const body = { email, password };\n    return this.http.post<AuthResponse>(`${this.baseUrl}/login`, body).pipe(\n      tap((resp) => {\n        if (resp.ok) {\n          localStorage.setItem('token', resp.token!);\n          this._usuario = {\n            nombre: resp.nombre!,\n            uid: resp.uid!,\n            email: resp.email!,\n          };\n        }\n      }),\n      map((resp) => resp.ok)\n    );\n  }\n\n  logOut() {\n    localStorage.removeItem('token');\n    this._auth = undefined;\n  }\n\n  validarToken(): Observable<boolean> {\n    const url = `${this.baseUrl}/auth/renovar`;\n    const headers = new HttpHeaders().set(\n      'x-token',\n      localStorage.getItem('token') || ''\n    );\n\n    return this.http.get<AuthResponse>(url, { headers }).pipe(\n      map((resp) => {\n        localStorage.setItem('token', resp.token!);\n        this._usuario = {\n          nombre: resp.nombre!,\n          uid: resp.uid!,\n          email: resp.email!,\n        };\n        return resp.ok;\n      }),\n      catchError((err) => of(false))\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}